# REQ-002: Shadow 功能完善 & 缓存 & 句子修复

## Overview

REQ-001 完成了项目骨架和核心播放器，但功能开关只有 UI 没有实际逻辑，跟读（shadow）完全不可用。
本需求聚焦：让功能开关真正生效、实现跟读核心循环、增加句子合并修复、增加转写缓存。

## 1. 功能开关改造

### 现状问题

- 功能开关藏在右侧抽屉面板里，不直观
- 开关只改 localStorage，不影响播放行为

### 目标

- 功能开关以**按钮/开关组**形式放在播放器区域的**顶部或底部一排**，始终可见
- 每个开关切换后**立即影响播放行为**，无需刷新

### 需要实时生效的开关

| 开关   | 说明                         |
|------|----------------------------|
| 单句循环 | 启用后当前句播完自动重播（可配置循环次数或无限循环） |
| 智能间隔 | 启用后每句播完暂停一段时间供用户跟读         |
| 字幕遮挡 | 启用后遮挡视频区域底部的内嵌字幕           |

> 其他高级功能（发音评分、间隔重复、填空、AI 分析）暂不实现，开关可保留但标记为"即将推出"。

## 2. 跟读（Shadow）核心功能

### 2.1 单句循环

- 启用后，当前句播放完毕自动跳回 `segment.start` 重播
- 提供**循环次数选择**：1次、2次、3次、5次、无限循环
- 循环次数达到后自动进入下一句
- 无限循环模式下需手动点击下一句或按快捷键前进

### 2.2 智能间隔（Smart Gap）

- 启用后，每句播放完毕后**自动暂停**一段时间
- 暂停时长 = 该句时长 × **1.2 系数**
    - 例：句子 2 秒 → 暂停 2.4 秒
- 暂停结束后自动继续播放（或进入下一次循环）
- 可与单句循环组合使用：播放 → 暂停跟读 → 重播 → 暂停跟读 → …

### 2.3 组合行为

- 单句循环 OFF + 智能间隔 OFF → 正常连续播放（现有行为）
- 单句循环 OFF + 智能间隔 ON → 每句播完暂停跟读，然后自动下一句
- 单句循环 ON + 智能间隔 OFF → 当前句循环 N 次，然后下一句
- 单句循环 ON + 智能间隔 ON → 当前句播放 → 暂停跟读 → 重播 → 暂停跟读 → 达到次数后下一句

### 2.4 快捷键

| 快捷键   | 功能         |
|-------|------------|
| Space | 播放 / 暂停    |
| Enter | 重播当前句      |
| ←     | 上一句        |
| →     | 下一句        |
| ↑     | 加速 (+0.1x) |
| ↓     | 减速 (-0.1x) |

- 快捷键说明需要在 UI 中展示（tooltip 或帮助面板）

## 3. 句子合并功能

### 现状问题

- Whisper 自动分句有时不准确，一句话被拆成多个 segment
- 当前无法修复

### 目标

- 用户可以在 TranscriptPanel 中选择**两个或多个相邻句子**进行合并
- 合并逻辑：
    - `start` = 第一个句子的 start
    - `end` = 最后一个句子的 end
    - `text` = 所有句子文本拼接（空格分隔）
    - 合并后重新编号 id
- 合并后结果**持久化到缓存**，下次打开同一视频直接读取修复后的版本

### 交互方式

- 点击句子进入"选择模式"，选中的句子高亮
- 选择多个相邻句子后出现"合并"按钮
- 点击合并后立即更新 TranscriptPanel 和播放行为

## 4. 转写结果缓存

### 现状问题

- 每次选择视频都重新上传 + 完整 Whisper 转写，耗时且浪费资源

### 目标

- 相同视频文件只转写一次，后续直接读取缓存
- 视频文件发生变化时自动重新转写

### 方案

- 前端计算视频文件的 **SHA256 hash**
- 后端缓存目录：`~/.afterglow/cache/`
- 缓存文件命名：`{hash}.json`
- API 流程：
    1. 前端计算 hash，先调用 `GET /api/cache/{hash}` 查询缓存
    2. 缓存命中 → 直接返回结果，跳过转写
    3. 缓存未命中 → 上传视频，转写，结果存入缓存后返回
- 用户手动合并 segment 后，更新缓存中的 JSON

## 5. 字幕遮挡

- 启用后在视频区域底部覆盖一个**不透明遮挡条**
- 遮挡视频内嵌的硬字幕
- 遮挡条高度可调（拖拽或预设大/中/小）

## Acceptance Criteria

- [ ] 功能开关以按钮组形式常驻显示，切换后立即影响播放
- [ ] 单句循环可选次数（1/2/3/5/无限），循环行为正确
- [ ] 智能间隔按 句子时长 × 1.2 暂停，暂停后自动继续
- [ ] 单句循环 + 智能间隔组合使用行为正确
- [ ] 快捷键全部可用，UI 中有快捷键说明
- [ ] 可选择相邻句子并合并，合并后 segment 数据正确
- [ ] 相同视频文件第二次加载时直接读取缓存，无需重新转写
- [ ] 视频文件变化后自动重新转写
- [ ] 合并后的 segment 持久化到缓存
- [ ] 字幕遮挡开关可用，遮挡条覆盖视频底部

---

## Original Feedback

<details>
<summary>点击展开原始反馈</summary>

我注意到你有很多功能只是写了，但是并没有实现

首先前端里的功能选择那些，应该是实时放在外面并且实时生效的

然后我发现这个模型不太准，就是一句话可能拆分的不对，最好给我一个能修复的办法，比如点两个句子可以直接操作合并那个json

另外我发现相同的视频，居然每次都要执行处理一遍，这个不对，应该有个缓存机制，处理过的视频应该直接读取之前的结果，除非视频文件发生了变化才重新处理

最重要的是当前的shadow根本shadow不起来

</details>
